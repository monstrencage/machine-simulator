
<div id="editor" class="section">
  <h1><i class="fa fa-edit"></i> Éditeur</h1>
  <div class="editor panel" id="editor-panel">
    <div style="color:transparent;position:absolute" id="txt-sample" class="txt-sample">a</div>
    <div class="editor-display" id="editor-display">
      <span></span>
    </div>
      <textarea id='src' wrap='off' spellcheck='false' class="input-field">{% if include.init-machine %}{{ include.init-machine}}{% endif %}
      </textarea>
  </div>
  <div class="compilation-msg panel" id="compilation-panel">
    <h3 style="margin-top:0">Messages de sortie du compilateur</h3>
    <p id="compilation-msg"></p>
  </div>
  <div class="control-panel panel">
    <button class="btn btn--primary txt" id="compile"><!-- -->
      <i class="fa fa-cog"></i>Charger la machine</button>
  </div><!-- -->
</div>


<script>
  const editorElts = {
      input: document.getElementById('src'),
      output: document.getElementById('editor-display'),
      dialogue_outer : document.getElementById("compilation-panel"),
      dialogue_inner : document.getElementById("compilation-msg"),
      button: document.getElementById('compile')
  }

  const output = {
      ok: false,
      value: 0
  }

  makeEditor(editorElts, output, compile)
</script>

<div id="simulator" class="section">
  <h1><i class="fas fa-robot"></i> Simulateur<div id="tm-name"></div></h1>
  <div class="input-panel panel section">
    {% if include.init-word %}
    <input class="input-field" type='text' id='input-str' value='{{include.init-word}}'/>
    {% else %}
    <input class="input-field" type='text' id='input-str'/>
    {% endif %}
    <button onclick="load()" class="btn btn--primary txt"><i class="fa fa-undo"></i> Charger mot d'entrée</button>
    <script>
      txtinput = document.getElementById("input-str")
      txtinput.addEventListener('keydown', event => {
          if (event.key === 'Enter') {
              load()
              document.getElementById("simulator-panel").scrollIntoView()
              txtinput.blur()
          }
      })
    </script>
  </div>
  <div class="section simulator-panel" id="simulator-panel" >
    <div class="top-panel">
      <div class="status-panel">
        <div># d'étapes : <span id='tm-nb-steps'></span></div><span class="space"></span>
        <div><i id='tm-status' class="fas fa-pause-circle"></i></div>
      </div>
      <div class="control-panel">
        <div class="elt button-panel">
          <button onclick="runback()"
                  class='btn btn--primary'
                  title="Rembobiner">
            <i class="fas fa-fast-backward"></i>
          </button><button onclick="back()"
                  class='btn btn--primary'
                  title="Reculer d'une étape">
            <i class="fas fa-step-backward"></i>
          </button><button onclick="step()"
                  class='btn btn--primary'
                  title="Avancer d'une étape">
            <i class="fas fa-step-forward"></i>
          </button><button onclick="run()"
                  class='btn btn--primary'
                  title="Laisser tourner">
            <i class="fas fa-fast-forward"></i>
          </button><button onclick="stop()"
                  class='btn btn--primary'
                  title="Arrêter l'exécution">
            <i class="fas fa-stop"></i>
          </button><button onclick="toggleLockView()"
                  class='view btn btn--primary'
                  title="Débloquer les rubans"
                  id="lock-btn" >
            <i class="fas fa-lock" id="lock-btn-ico"></i>
          </button>
        </div>
        <div class="elt speedo">
          <div class="elt">
            <i class="fas fa-tachometer-alt"></i> vitesse:
            <div id='speedtxt'></div>
          </div>
          <input id="speedo"
                 type="range"
                 list="speeds"
                 min="0"
                 max="5"
                 value="2"
                 />
          <datalist id="speeds">
            <option value="0" label="lent"></option>
            <option value="1" label="normal"></option>
            <option value="2" label="plus vite"></option>
            <option value="3" label="rapide"></option>
            <option value="4" label="très rapide"></option>
            <option value="5" label="à toute vitesse"></option>
          </datalist>
          <script>
            var delay = 1000

            function updTxt(id, txt){
                document.getElementById(id).innerHTML = txt
            }
            
            function updDelay(){
                switch(Math.trunc(document.getElementById('speedo').value)){
                case 0:
                    delay = 2000;
                    updTxt("speedtxt", "très lente")
                    break
                case 1:
                    delay = 1000;
                    updTxt("speedtxt", "tranquille")
                    break
                case 2:
                    delay = 750;
                    updTxt("speedtxt", "confortable")
                    break
                case 3:
                    delay = 500;
                    updTxt("speedtxt", "rapide")
                    break
                case 4:
                    delay = 100;
                    updTxt("speedtxt", "véloce")
                    break
                case 5:
                    delay = 0;
                    updTxt("speedtxt", "youhouhou!")
                    break
                }
            }

            document.getElementById('speedo').onchange = updDelay
            
          </script>
        </div>
      </div>
    </div>
    <div class="table-tape section" id="table-tape-section">
      <div class="table-tape" id="table-tape">
        <table>
          <tbody id="simulator-frame">
          </tbody>
        </table>
      </div>
    </div>
    <div class="graph-visualizer" id="graph-of-tm"></div>
    <script>
        const graph = new GraphTM("graph-of-tm", "src")
    </script>
    <div class="hidden" id="pop-up-outer">
      <div class="pop-up-outer"></div>
      <div class="pop-up" id="pop-up">
        <h2 id="pop-up-title"></h2>
        <button class="close" onclick="hidePopUp()" title="Fermer">
          <i class="fas fa-times"></i>
        </button>
        <div class="pop-up-content" id="pop-up-content"></div>
      </div>
    </div>
    <script>
      function hidePopUp(){
          document.getElementById("pop-up-outer").classList.add("hidden")
      }
      
      function notifySuccess(myenv, inputword){
          let status = document.createElement("i")
          status.className = document.getElementById("tm-status").className
          document.getElementById("pop-up-outer").classList.remove("hidden")
          document.getElementById("pop-up-title").innerHTML = "Exécution terminée :"
          document.getElementById("pop-up-title").appendChild(status)
          if (myenv.accepted){       
              document.getElementById("pop-up-content").innerHTML
                  = `Le mot "${inputword}" est accepté.`
          } else {    
              document.getElementById("pop-up-content").innerHTML
                  = `Le mot "${inputword}" est rejetté.`
          }
          if (myenv.machine.output > 0){
              var output = myenv.tapes[myenv.machine.output - 1].content
              document.getElementById("pop-up-content").innerHTML
                  += `<br>Sortie : ${output.past}${output.present}${output.future}`
          }
      }
    </script>
  </div>
</div>
<script>
  var myenv  
  let steps = document.getElementById('tm-nb-steps')
  let status = document.getElementById('tm-status')
  var inputword = ''
  var _run = false
  var _keeprunning = false
  var _finished = false
  var _forwards = true
  
  // create a network

  var _locked = true


  document.addEventListener(
      'keydown', event => {
          let elt = document.activeElement
          if (! elt.classList.contains("input-field")){
              if (event.key === ' ') {
                  if (document.getElementById("pop-up-outer").classList.contains("hidden")){
                      if (_keeprunning){
                          stop()
                      }else{
                          run()
                      }
                  }else{
                      hidePopUp()
                  }
              } else if (event.key === '+') {
                  let lvl = Math.trunc(document.getElementById('speedo').value)
                  if (lvl > 0){
                      document.getElementById('speedo').value = lvl + 1
                      updDelay()
                  }
              } else if (event.key === '-') {
                  let lvl = Math.trunc(document.getElementById('speedo').value)
                  if (lvl < 5){
                      document.getElementById('speedo').value = lvl - 1
                      updDelay()
                  }
              } else if (event.key === 'Enter' && ! document.getElementById("pop-up-outer").classList.contains("hidden")){
                  hidePopUp()
              }
          }
      }
  )

  function toggleLockView(){
      var btn = document.getElementById("lock-btn")
      var ico = document.getElementById("lock-btn-ico")
      _locked = ! _locked
      if (_locked){
          focusView()
          ico.className = "fas fa-lock"
          btn.title = "Débloquer les rubans"
      }else{
          ico.className = "fas fa-lock-open"
          btn.title = "Centrer automatiquement les rubans"
      }
  }

  function focusView(){
      if (_locked && ! document.getElementById("table-tape-section").classList.contains("hidden")){
          var bodyRect = document.getElementById("table-tape").getBoundingClientRect(),
              elemRect = document.getElementById("table-state").getBoundingClientRect(),
              offset   = elemRect.left - bodyRect.left;
          document.getElementById("table-tape").scrollLeft = offset
      }
  }
  
  function prepareTableTape(){
      const body = document.getElementById("simulator-frame")
      body.innerHTML = "<tr class='filler'><td></td><td><div class='state' id='table-state'></div><div class='pointer'></div></td><td></td></tr>"
      for (var row, cell, i = 0; i < myenv.machine.nb_tapes; i++){
          if(i > 0){
              row = document.createElement("tr")
              row.className = "filler"
              body.appendChild(row)
          }
          row = document.createElement("tr")
          row.id = `tape-${i}`
          row.className = "tape"
          body.appendChild(row)
          cell = document.createElement("td")
          cell.id = `past-${i}`
          cell.className = "tape past-tape"
          row.appendChild(cell)
          cell = document.createElement("td")
          cell.id = `current-${i}`
          cell.className = "tape current-tape"
          row.appendChild(cell)
          cell = document.createElement("td")
          cell.id = `future-${i}`
          cell.className = "tape future-tape"
          row.appendChild(cell)
      }
  }

  function makespaces(s){
      return s.replaceAll(' ','<span class="emptysymb">#</span>')
  }
  function updateTableTape(){
      document.getElementById('table-state').innerHTML = myenv.etat
      var content =  myenv.tapes.map(function (t) {return t.content})

      for (var i = 0; i < myenv.machine.nb_tapes; i++){
          document.getElementById(`past-${i}`).innerHTML =
              makespaces(content[i].past)
          document.getElementById(`current-${i}`).innerHTML =
              makespaces(content[i].present)
          document.getElementById(`future-${i}`).innerHTML =
              makespaces(content[i].future)
      }
  }

  
  
  
  function highlight_current(){
      var eid
      if (myenv.history.length > 0){
          eid = myenv.history[myenv.history.length - 1].id
      }else{
          eid = 'e_init'
      }
      graph.highlight(myenv.etat, eid)
  }
  
  function compile(mytm){
      graph.upd(mytm)
      myenv = new TuringEnv(mytm, '')
      if (mytm.name != ""){
          document.getElementById("tm-name").innerHTML = ` : ${mytm.name}`
      }else{
          document.getElementById("tm-name").innerHTML = ""
      }
      load();
  }

  function load(){
      stop()
      inputword = document.getElementById("input-str").value
      myenv.reset(inputword)
      _finished = myenv.accepted
      steps.innerHTML = myenv.nb_steps
      prepareTableTape()
      updateTableTape()
      update_status()
  }

  function do_step(){
      var success
      if (!_run){
          _run = true
          if (_forwards){
              success = myenv.step()
          } else {
              success = myenv.back()
          }
          _run = false
          _keeprunning = _keeprunning && success
          updateTableTape()
          focusView()
          steps.innerHTML = myenv.nb_steps
          if (_keeprunning) {
              highlight_current()
              setTimeout(do_step, delay)
          } else{
              _finished = _forwards && !success
              update_status()
              if(_finished){
                  notifySuccess(myenv, inputword)
              }
          }
      }
  }


  function update_status(){
      highlight_current()
      status.classList.remove('fa-check-circle')
      status.classList.remove('fa-times-circle')
      status.classList.remove('fa-pause-circle')
      status.classList.remove('fa-spin')
      status.classList.remove('fa-cog')
      if (_run || _keeprunning){
          status.classList.add('fa-spin')
          status.classList.add('fa-cog')
      } else if (_finished){
          if (myenv.accepted){
              status.classList.add('fa-check-circle')
          } else { 
              status.classList.add('fa-times-circle')
          }
      } else {
          status.classList.add('fa-pause-circle')
      }
  }
  
  function step(){
      if (!_keeprunning && !_run){
          _forwards = true
          update_status()
          do_step()
      }
  }

  function run(){
      if (!_keeprunning && !_run){
          _forwards = true
          _keeprunning = true
          update_status()
          do_step()
      }
  }

  function back(){
      if (!_keeprunning && !_run){
          _forwards = false
          update_status()
          do_step()
      }
  }

  function runback(){
      if (!_keeprunning && !_run){
          _forwards = false
          _keeprunning = true
          update_status()
          do_step()
      }
  }
  
  function stop(){
      _run = false
      _keeprunning = false
  }

  updDelay()
  compile(output.value)

</script>
